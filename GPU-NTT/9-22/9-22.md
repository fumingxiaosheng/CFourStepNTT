## 基于使用共享内存完成矩阵转置的测试结果 forward
循环卷积NTT

|维度n|原先耗时|现在耗时|时间减少| merge时间|
| :-----: | :-----: | :-----: | :-----: | :-----: |
|12|2.66+5.78+4.70+2.62 = 15.76 us| 5.70+4.67 = 10.37 us | 34.21% | 4 + 5.89 = 9.89us |
|13|2.72+5.73+5.18+2.72 = 16.35 us| 5.79+5.06 = 10.85 us | 33.64% | 4.54 + 6.05 = 10.59us|
|14|3.10+5.76+6.11+3.04=18.01 us| 6.02 + 6.34 = 12.36 us | 31.38% | 5.22 + 6.21 = 11.43 us |
|15|3.65+7.23+7.55+3.71 = 22.14 us |6.40 + 9.41 = 15.81 us(基于cyclic_5) 或 7.23 + 7.65 = 14.88 us | 28.59% 或者32.80% |6.46 + 7.52 = 13.98 us|
|16|5.09+9.73+12.10+5.18 = 32.1us | 9.57 + 12.13 = 21.7 us 或者优化存储体冲突 9.57 + 12.10 = 21.67 | 32.40% | 10.11 + 10.98 = 21.09us |
|17| 8.16 + 12.19+12.10+15.26+8.10 = 55.81 us |12.03 + 12.32 + 15.26 = 39.61us | 29.03% | 11.26 + 12.03 + 17.41 = 40.7 
|18| 13.28 + 19.46 + 21.60 + 24.67 + 13.50 = 92.51 us | 20.03 + 21.22 + 24.83 = 66.08 us | 28.57% | 17.54 + 20.03 + 28.48 = 66.05 |
|19| 23.04 + 31.36 + 38.40 + 44.96 + 22.82 = 160.58 us |30.69 + 37.95 + 45.02 = 113.66 us | 29.22% | 33.89 + 34.30 + 51.04 = 119.23
|20 |43.39 + 52.86 + 78.50 + 84.61 + 43.46 = 302.82 |53.95 + 77.34 + 84.42 = 215.71 us | 28.77% | 62.27 + 72.90 + 96.16 = 231.33
|21|84.80 + 111.84 + 146.50 + 160.22 + 84.99 = 588.35 us| 113.09 + 145.50 + 159.97 = 418.56 us | 28.86% | 138.18 + 137.82 + 183.33 = 459.33 
|22| 173.38 + 246.56 + 282.88 + 312.80 + 172.90 = 1188.52us |247.10 + 281.57 + 314.88 = 843.55 us 或者 247.87 + 283.26 + 312.74 = 843.87us | 29.03% | 265.82 + 310.78 + 354.94 = 931.54
|23| 342.46 + 480.22 + 630.24 + 621.79 + 343.17 = 2417.88us |484.67 + 625.95 + 618.37 =1728.99us 或者优化存储体冲突 481.82 + 626.27 + 619.04 = 1727.12 | 28.50% 或者28.57%| 634.14 + 612.03 +701.12 = 1947.29
|24 | 694.21 + 1140 + 1240 + 1230 + 696.03 =5000.24 | 1280 + 1240 + 1230 = 3750us 或者优化存储体冲突 1160 + 1240 + 1230 = 3630us | 25.01% 或者27.41% | 1260 + 1260 + 1680 = 4200 us

负循环卷积NTT
| 维度n | 耗时 us |
| :-----: | :-----: |
|12|6.05+4.74 = 10.79|
|13 |6.08 + 5.41 = 11.49|
|14| 6.3 + 6.08 = 12.38|
|15| 6.75 + 8.99 = 15.74 或者 7.42+7.81 = 15.23|
|17| 12.16 + 11.84 + 15.26 = 39.26|
|18| 20 + 21.09 +24.77 = 65.86|
|19| 31.58 + 38.18 + 44.96 = 114.72|
|20| 52.77 + 78.37 + 83.58 = 214.72 |
|21| 110.82 + 145.15 + 160.06 = 416.03 |
|22| 249.89 + 283.30 + 313.09 = 846.28 |
|23| 491.26 + 626.75 + 628.48 = 1746.49 |
|24| 1170 + 1240 + 1230 = 3640 |

## 基于使用共享内存完成矩阵转置的测试结果 inverse
土耳其代码中,求逆是在CPU上做的

## 如何进行实验
### 和C实现比较
https://github.com/microsoft/SEAL

#### 和openFHE进行比较
```bash
hxw@lyx:~/CUDA/4-step-baseline/openfhe-development/src/core/include/math$ tree
.
├── binaryuniformgenerator.h
├── binaryuniformgenerator-impl.h
├── chebyshev.h
├── dftransform.h
├── discretegaussiangeneratorgeneric.h
├── discretegaussiangenerator.h
├── discretegaussiangenerator-impl.h
├── discreteuniformgenerator.h
├── discreteuniformgenerator-impl.h
├── distrgen.h
├── distributiongenerator.h
├── hal
│   ├── **basicint.h**
│   ├── bigintbackend.h
│   ├── bigintdyn
│   │   ├── backenddyn.h
│   │   ├── mubintvecdyn.h
│   │   ├── **transformdyn.h** //负
│   │   ├── transformdyn-impl.h
│   │   └── ubintdyn.h
│   ├── bigintfxd
│   │   ├── backendfxd.h
│   │   ├── mubintvecfxd.h
│   │   ├── **transformfxd.h** //负
│   │   ├── transformfxd-impl.h
│   │   └── ubintfxd.h
│   ├── bigintntl
│   │   ├── backendntl.h
│   │   ├── mubintvecntl.h
│   │   ├── **transformntl.h** //负
│   │   ├── transformntl-impl.h
│   │   └── ubintntl.h
│   ├── integer.h
│   ├── intnat
│   │   ├── mubintvecnat.h
│   │   ├── transformnat.h //负
│   │   ├── transformnat-impl.h
│   │   └── ubintnat.h
│   ├── nativeintbackend.h
│   ├── transform.h //负
│   └── vector.h
├── math_backends.md
├── math-hal.h
├── matrix.h
├── matrix-impl.h
├── matrixstrassen.h
├── matrixstrassen-impl.h
├── nbtheory.h
├── nbtheory-impl.h
├── README.md
├── SAMPLING_README.md
├── ternaryuniformgenerator.h
└── ternaryuniformgenerator-impl.h

5 directories, 48 files
```
1.确定数据类型
src/core/include/math/hal/basicint.h 中可以根据宏 NATIVEINT 来决定实际使用的数据类型
2.确定环是什么

src/core/include/math/hal/transform.h

```bash
hxw@lyx:~/CUDA/4-step-baseline/openfhe-development/build$ ./bin/benchmark/poly-benchmark-4k //64
Generating polynomials for the benchmark...
Polynomials for the benchmark are generated
2024-09-24T11:15:54+08:00
Running ./bin/benchmark/poly-benchmark-4k
Run on (32 X 5700 MHz CPU s)
CPU Caches:
  L1 Data 48 KiB (x16)
  L1 Instruction 32 KiB (x16)
  L2 Unified 2048 KiB (x16)
  L3 Unified 36864 KiB (x1)
Load Average: 0.81, 0.58, 0.38
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
----------------------------------------------------------------------------------
Benchmark                                        Time             CPU   Iterations
----------------------------------------------------------------------------------
Native_AddEq                                  1.39 us         1.39 us       500473
DCRT_AddEq/towers:1                           1.50 us         1.50 us       465636
DCRT_AddEq/towers:2                           2.86 us         2.86 us       244372
DCRT_AddEq/towers:4                           5.63 us         5.63 us       124126
DCRT_AddEq/towers:8                           11.2 us         11.2 us        62338
DCRT_AddEq/towers:16                          22.3 us         22.3 us        31355
Native_SubEq                                  9.69 us         9.69 us        72179
DCRT_SubEq/towers:1                           9.83 us         9.83 us        71179
DCRT_SubEq/towers:2                           19.5 us         19.5 us        35818
DCRT_SubEq/towers:4                           38.9 us         38.9 us        17967
DCRT_SubEq/towers:8                           78.1 us         78.1 us         8958
DCRT_SubEq/towers:16                           157 us          157 us         4464
Native_MulEq                                  4.61 us         4.61 us       152237
DCRT_MulEq/towers:1                           4.77 us         4.77 us       146547
DCRT_MulEq/towers:2                           9.44 us         9.44 us        74012
DCRT_MulEq/towers:4                           18.8 us         18.8 us        37324
DCRT_MulEq/towers:8                           37.3 us         37.3 us        18789
DCRT_MulEq/towers:16                          74.2 us         74.2 us         9449
Native_ntt                                    24.4 us         24.4 us        28750
DCRT_ntt/towers:1                             24.5 us         24.5 us        28606
DCRT_ntt/towers:2                             48.8 us         48.8 us        14343
DCRT_ntt/towers:4                             97.9 us         97.9 us         7144
DCRT_ntt/towers:8                              196 us          196 us         3567
DCRT_ntt/towers:16                             393 us          393 us         1783
Native_intt                                   26.0 us         26.0 us        27050
DCRT_intt/towers:1                            26.1 us         26.1 us        26720
DCRT_intt/towers:2                            52.2 us         52.2 us        13311
DCRT_intt/towers:4                             105 us          105 us         6692
DCRT_intt/towers:8                             209 us          209 us         3360
DCRT_intt/towers:16                            418 us          418 us         1671
Native_CRTInterpolate                        0.431 us        0.431 us      1624289
DCRT_CRTInterpolate/towers:1                   159 us          159 us         4383
DCRT_CRTInterpolate/towers:2                   566 us          566 us         1230
DCRT_CRTInterpolate/towers:4                   989 us          989 us          709
DCRT_CRTInterpolate/towers:8                  1832 us         1832 us          381
DCRT_CRTInterpolate/towers:16                 3640 us         3640 us          192
Native_DecryptionCRTInterpolate               11.0 us         11.0 us        63349
DCRT_DecryptionCRTInterpolate/towers:1         369 us          369 us         1890
DCRT_DecryptionCRTInterpolate/towers:2         790 us          790 us          885
DCRT_DecryptionCRTInterpolate/towers:4        1263 us         1263 us          556
DCRT_DecryptionCRTInterpolate/towers:8        2165 us         2165 us          323
DCRT_DecryptionCRTInterpolate/towers:16       4102 us         4102 us          171
Native_BaseDecompose                          1542 us         1542 us          453
DCRT_BaseDecompose/towers:1                   8623 us         8622 us           81
DCRT_BaseDecompose/towers:2                  22572 us        22571 us           31
DCRT_BaseDecompose/towers:4                  70514 us        70512 us            9
DCRT_BaseDecompose/towers:8                 231011 us       231004 us            3
DCRT_BaseDecompose/towers:16                815222 us       815193 us            1


hxw@lyx:~/CUDA/4-step-baseline/openfhe-development/build$ ./bin/benchmark/poly-benchmark-4k //32
Generating polynomials for the benchmark...
Polynomials for the benchmark are generated
2024-09-24T13:31:12+08:00
Running ./bin/benchmark/poly-benchmark-4k
Run on (32 X 5700 MHz CPU s)
CPU Caches:
  L1 Data 48 KiB (x16)
  L1 Instruction 32 KiB (x16)
  L2 Unified 2048 KiB (x16)
  L3 Unified 36864 KiB (x1)
Load Average: 0.00, 0.00, 0.00
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
----------------------------------------------------------------------------------
Benchmark                                        Time             CPU   Iterations
----------------------------------------------------------------------------------
Native_AddEq                                 0.503 us        0.503 us      1000000
DCRT_AddEq/towers:1                          0.596 us        0.596 us      1190872
DCRT_AddEq/towers:2                          0.793 us        0.793 us       881933
DCRT_AddEq/towers:4                           1.06 us         1.06 us       655725
DCRT_AddEq/towers:8                           1.30 us         1.30 us       511307
DCRT_AddEq/towers:16                          2.22 us         2.22 us       315569
Native_SubEq                                  9.60 us         9.60 us        72907
DCRT_SubEq/towers:1                           9.74 us         9.74 us        71828
DCRT_SubEq/towers:2                           9.98 us         9.98 us        70180
DCRT_SubEq/towers:4                           10.8 us         10.8 us        64925
DCRT_SubEq/towers:8                           11.3 us         11.3 us        61377
DCRT_SubEq/towers:16                          14.6 us         14.6 us        48035
Native_MulEq                                  3.49 us         3.49 us       189361
DCRT_MulEq/towers:1                           3.62 us         3.62 us       193554
DCRT_MulEq/towers:2                           3.96 us         3.96 us       176443
DCRT_MulEq/towers:4                           4.21 us         4.21 us       165626
DCRT_MulEq/towers:8                           4.68 us         4.68 us       148466
DCRT_MulEq/towers:16                          8.61 us         8.61 us        81045
Native_ntt                                    25.4 us         25.4 us        27462
DCRT_ntt/towers:1                             25.5 us         25.5 us        27443
DCRT_ntt/towers:2                             27.6 us         27.6 us        25352
DCRT_ntt/towers:4                             35.2 us         35.2 us        19870
DCRT_ntt/towers:8                             40.5 us         40.5 us        17209
DCRT_ntt/towers:16                            75.9 us         75.9 us         9245
Native_intt                                   26.0 us         26.0 us        26896
DCRT_intt/towers:1                            26.2 us         26.2 us        26762
DCRT_intt/towers:2                            28.3 us         28.3 us        24840
DCRT_intt/towers:4                            32.0 us         32.0 us        18418
DCRT_intt/towers:8                            37.9 us         37.9 us        16774
DCRT_intt/towers:16                           74.1 us         74.1 us         9441
Native_CRTInterpolate                        0.240 us        0.240 us      2911100
DCRT_CRTInterpolate/towers:1                   108 us          108 us         6234
DCRT_CRTInterpolate/towers:2                   175 us          175 us         4018
DCRT_CRTInterpolate/towers:4                   262 us          262 us         2751
DCRT_CRTInterpolate/towers:8                   409 us          409 us         1712
DCRT_CRTInterpolate/towers:16                  636 us          636 us         1093
Native_DecryptionCRTInterpolate               10.3 us         10.3 us        67501
DCRT_DecryptionCRTInterpolate/towers:1         359 us          359 us         1921
DCRT_DecryptionCRTInterpolate/towers:2         423 us          423 us         1655
DCRT_DecryptionCRTInterpolate/towers:4         509 us          509 us         1388
DCRT_DecryptionCRTInterpolate/towers:8         758 us          758 us          931
DCRT_DecryptionCRTInterpolate/towers:16       1146 us         1146 us          599
Native_BaseDecompose                           701 us          701 us          998
DCRT_BaseDecompose/towers:1                   5302 us         5302 us          132
DCRT_BaseDecompose/towers:2                  12226 us        12225 us           57
DCRT_BaseDecompose/towers:4                  31682 us        31679 us           22
DCRT_BaseDecompose/towers:8                  99070 us        99066 us            7
DCRT_BaseDecompose/towers:16                336213 us       336208 us            2
```

基础数据未int64_t时的测速结果 forward
|维度| tower = 1| tower = 2 | tower = 4 | tower = 8| tower = 16|
|------|------|------|------|------|------|
|12 | 24.5 us(10.27) | 48.8 us(10.56) | 97.9(11.04) | 196(12.83) | 393 (16.50) |
|13 | 52.6(10.79) |  106(11.23) | 212(13.25) | 423(17.5) | 860(27.93) |
|14 | 113(11.94) | 226(13.73) | 451(19.11) | 918(29.25) | 1868(48.96) |
|16 | 512(21.70) | 1032(33.57) | 2102(54.72) | 4251(93.92) | 8536(169.76)|


### 和GPU实现相比
#### over 100x
编译与build
按照Run.ipynb编译步骤，出现如下所示的报错。
```bash
/usr/include/c++/11/bits/std_function.h:530:146: note:         ‘_ArgTypes’
make[2]: *** [CMakeFiles/DeviceFunctions.dir/build.make:76：CMakeFiles/DeviceFunctions.dir/src/public/DeviceVector.cu.o] 错误 1
make[2]: *** 正在等待未完成的任务....
make[2]: *** [CMakeFiles/DeviceFunctions.dir/build.make:118：CMakeFiles/DeviceFunctions.dir/src/public/MultPtxtBatch.cu.o] 错误 1
/usr/include/c++/11/bits/std_function.h:435:145: error: parameter packs not expanded with ‘...’:
  435 |         function(_Functor&& __f)
      |                                                                                                                                                 ^ 
/usr/include/c++/11/bits/std_function.h:435:145: note:         ‘_ArgTypes’
/usr/include/c++/11/bits/std_function.h:530:146: error: parameter packs not expanded with ‘...’:
  530 |         operator=(_Functor&& __f)
      |                                                                                                                                                  ^ 
/usr/include/c++/11/bits/std_function.h:530:146: note:         ‘_ArgTypes’
```
使用(如下所示的方法)[https://github.com/NVIDIA/nccl/issues/650]使得编译正确
```bash
That does not help, at least not in Debian.
However, what does help is making the following two changes in /usr/include/c++/*/bits/std_function.h :

Line 433+ (approximate):

  template<typename _Functor,
           typename _Constraints = _Requires<_Callable<_Functor>>>
    function(_Functor&& __f)
    //noexcept(_Handler<_Functor>::template _S_nothrow_init<_Functor>()) // CUDA BOTCHES THIS
    : _Function_base()
Line 529+ (approximate):

  template<typename _Functor>
    _Requires<_Callable<_Functor>, function&>
    operator=(_Functor&& __f)
    //noexcept(_Handler<_Functor>::template _S_nothrow_init<_Functor>()) // CUDA BOTCHES THIS
    {
      function(std::forward<_Functor>(__f)).swap(*this);
      return *this;
    }
Commenting out the indicated part solves the compilation. For some reason, NVCC botches the compilation when that part is present. It preprocesses the C++ code and erroneously changes the template signature in a way that does not and can not compile.
```
### Accelerating Number Theoretic Transformations for Bootstrappable Homomorphic Encryption on GPUs
#### batch_size大小
探讨不同batch_size大小对于单一NTT实现效率的影响
#### 合并内存访问
探讨合并和未合并内存访问对效率的影响

#### 存储预计算表

### cuDilithium

function,trials,min (us),median (us),std. dev.

+++++++++++++++++++++++++
grid_dim = 10000
seo ntt,10000,983.968,1010.69,0.0170481
4_step,10000,52.896,54.048,0.000896711
ntt radix2 opt 2,10000,53.92,54.944,0.00100218

+++++++++++++++++++++++++
grid_dim = 1000
seo ntt,10000,80.704,89.824,0.0022066
4_step,10000,7.168,7.84,0.00043817
ntt radix2 opt 2,10000,7.168,8.032,0.000492248

++++++++++++++++++++++++
grid_dim = 100
seo ntt,10000,10.24,11.264,0.000488269
4_step,10000,2.72,3.072,0.000302868
ntt radix2 opt 2,10000,2.88,3.072,0.000361266

++++++++++++++++++++++++
grid_dim = 10
seo ntt,10000,9.216,10.24,0.000271995
4_step,10000,2.048,3.072,0.000385838
ntt radix2 opt 2,10000,2.048,3.072,0.000241316

++++++++++++++++++++++++
grid_dim = 1
seo ntt,10000,9.216,10.176,0.000325251
4_step,10000,2.048,3.04,0.000305464
ntt radix2 opt 2,10000,2.048,3.072,0.000317654

|grid_dim| 1 | 10 | 100 | 1000 | 10000|
|------|------|------|------|------|------|  
|ntt | 10.176 | 10.24 | 11.264 | 89.824 | 1010.69|
|ntt no bank conflicts | 3.072 | 3.072 | 3.072 | 8.032 | 54.944
|4_step | 3.04 | 3.072 | 3.072 | 7.84 | 54.048|

## 投到哪个期刊?
### 会议 CHES 2025 截止日期 10.16
https://ches.iacr.org/2025/callforpapers.php

### 期刊的话->问下诗羽姐



## 论文写作
### 常使用符号
\mathbf 加粗
\mathsf 操作
### NTT相关文献积累
Q:之前对于NTT的gpu实现有哪些?他们的实现方法的特点是什么

#### Two Algorithms for Fast GPU Implementation of NTT

The access pattern to the memory, on the other hand, may play much greater role, as the NTT execution time is mostly memory-bound due to large degree polynomials.

The 4-Step NTT algorithm computes much smaller (n1-point and n2-point against n-point NTT operations) and independent NTT computations, which exploits the parallel processing and locality of memory access much better than the Merge NTT algorithm.


### 关于4-STEP NTT
Q: 4-step NTT的优势来源是什么?

optimizing the memory access patterns. 在GPU上对于NTT的优化主要是基于访存模式的优化


